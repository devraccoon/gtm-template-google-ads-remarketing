___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "categories": [
    "ADVERTISING",
    "REMARKETING"
  ],
  "displayName": "Raccoon Google Ads Remarketing",
  "brand": {
    "id": "brand_dummy",
    "displayName": "gtm-templates-raccoon-marketing-digital",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Unofficial Google Tag Manager template for Google Ads Remarketing tag. This template solves a bug on the original tag, that ignores the \"Event Value\" remarketing parameter set on the tag.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "conversionId",
    "displayName": "Conversion ID",
    "simpleValueType": true,
    "help": "To find the Conversion ID, see \u003ca href\u003d\"https://support.google.com/tagmanager/answer/6106960\"\u003eStandard Google Ads remarketing\u003c/a\u003e.",
    "alwaysInSummary": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "POSITIVE_NUMBER"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "google_gtag_event_data",
    "checkboxText": "Send dynamic remarketing event data",
    "simpleValueType": true,
    "subParams": [
      {
        "type": "TEXT",
        "name": "gtagEventName",
        "displayName": "Event Name",
        "simpleValueType": true,
        "help": "The dynamic remarketing event name. For best performance, the value should be one of the recommended values for your business type.",
        "enablingConditions": [
          {
            "paramName": "google_gtag_event_data",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          },
          {
            "type": "REGEX",
            "args": [
              "view_search_results|view_item_list|view_item|add_to_cart|purchase"
            ]
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "gtagEventValue",
        "displayName": "Event Value",
        "simpleValueType": true,
        "help": "The value of the remarketing event. This represents the total value of the products or services the user is interacting with.",
        "enablingConditions": [
          {
            "paramName": "google_gtag_event_data",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "SELECT",
        "name": "gtagEventItems",
        "displayName": "Event Items",
        "macrosInSelect": true,
        "selectItems": [],
        "simpleValueType": true,
        "help": "The list of items the user is interacting with. This variable must be an array of objects with properties following the dynamic remarketing item schema. Each item must have one or more of the following properties: \u0027id\u0027, \u0027location_id\u0027, \u0027origin\u0027, \u0027destination\u0027, \u0027start_date\u0027, \u0027end_date\u0027, \u0027google_business_vertical\u0027.",
        "enablingConditions": [
          {
            "paramName": "google_gtag_event_data",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "valueValidators": [
          {
            "type": "NON_EMPTY",
            "errorMessage": "Campo obrigatório."
          }
        ]
      }
    ],
    "help": "To find the Conversion Label, see \u003ca href\u003d\"https://support.google.com/tagmanager/answer/6106960\"\u003eStandard Google Ads remarketing\u003c/a\u003e."
  },
  {
    "type": "RADIO",
    "name": "google_custom_params",
    "displayName": "Custom Parameters",
    "radioItems": [
      {
        "value": "none",
        "displayValue": "None"
      },
      {
        "value": "datalayer",
        "displayValue": "Use Data Layer",
        "help": "Choose a variable that returns a ecomm_* dictionary.",
        "subParams": [
          {
            "type": "SELECT",
            "name": "customParamsDatalayer",
            "displayName": "Data Layer Variable",
            "macrosInSelect": true,
            "selectItems": [],
            "simpleValueType": true
          }
        ]
      },
      {
        "value": "manual",
        "displayValue": "Manually Specify",
        "subParams": [
          {
            "type": "SIMPLE_TABLE",
            "name": "customParamsManual",
            "displayName": "",
            "simpleTableColumns": [
              {
                "defaultValue": "",
                "displayName": "Key",
                "name": "Key",
                "type": "TEXT",
                "isUnique": true
              },
              {
                "defaultValue": "",
                "displayName": "Value",
                "name": "Value",
                "type": "TEXT"
              }
            ],
            "newRowButtonText": "+ Add Custom Parameter"
          }
        ],
        "help": "Make a table of ecomm_* keys and values."
      }
    ],
    "simpleValueType": true,
    "help": "These are the old DRA parameters: ecomm_*"
  },
  {
    "type": "GROUP",
    "name": "groupExtra",
    "displayName": "Extra Configs",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "google_user_id",
        "displayName": "user_id for cross-device linking",
        "simpleValueType": true,
        "help": "The user_id parameter is a unique, anonymous identifier that you should generate and send via the Google Ads remarketing tag that links different devices and browsers for a single user. \u003ca href\u003d\"https://support.google.com/google-ads/answer/7410411?hl\u003den\"\u003eReference\u003c/a\u003e."
      },
      {
        "type": "TEXT",
        "name": "google_conversion_label",
        "displayName": "Conversion Label",
        "simpleValueType": true,
        "help": "Only set if you really know what you are doing. It should be set only on conversion tags and audience tags. Although this template can\u0027t be used to create a conversion tag, it can be used to create an audience one."
      },
      {
        "type": "TEXT",
        "name": "google_conversion_page_url",
        "displayName": "Page URL",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "google_conversion_referrer_url",
        "displayName": "Referrer URL",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "google_conversion_currency",
        "displayName": "Currency",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "google_gtm",
        "displayName": "Google GTM ID",
        "simpleValueType": true,
        "help": "The official template tag sends a strange ID that closely resembles the GTM ID. Here you have the opportunity to submit a strange ID for any reason."
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
const injectScript = require('injectScript');
const callInWindow = require('callInWindow');
const makeTableMap = require('makeTableMap');

const payload = {};
payload.onload_callback = data.gtmOnSuccess;
payload.gtm_onFailure = data.gtmOnFailure;
payload.google_remarketing_only = true;
payload.google_conversion_id = data.conversionId;

switch (data.google_custom_params) {
  case 'datalayer':
    payload.google_custom_params = data.customParamsDatalayer;
    break;
  case 'manual':
    payload.google_custom_params = makeTableMap(data.customParamsManual, 'Key', 'Value');
    break;
}

payload.google_custom_params = payload.google_custom_params || {};

if (data.google_gtag_event_data) {
  payload.google_gtag_event_data = {
    items: data.gtagEventItems,
    value: data.gtagEventValue
  };
  payload.google_conversion_value = data.gtagEventValue;
  payload.google_custom_params.event = data.gtagEventName;
}

// Extra parameters
if (data.google_user_id) payload.google_user_id = data.google_user_id;
if (data.google_conversion_label) {
  payload.google_conversion_label = data.google_conversion_label;
  payload.google_custom_params = payload.google_custom_params || {};
  payload.google_custom_params.event = payload.google_custom_params.event || 'conversion'; // gtag sets this parameter to "conversion" on audience tags.
}
if (data.google_conversion_page_url) payload.google_conversion_page_url = data.google_conversion_page_url;
if (data.google_conversion_referrer_url) payload.google_conversion_referrer_url = data.google_conversion_referrer_url;
if (data.google_conversion_currency) payload.google_conversion_currency = data.google_conversion_currency;
if (data.google_gtm) payload.google_gtm = data.google_gtm;

function onSuccess() {
  callInWindow('google_trackConversion', payload);
}

injectScript('https://www.googleadservices.com/pagead/conversion_async.js', onSuccess, data.gtmOnFailure, 'https://www.googleadservices.com/pagead/conversion_async.js');


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://www.googleadservices.com/pagead/conversion_async.js*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "google_trackConversion"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

The official template for "Google Ads Remarketing" tag has a bug.

The official template was recently updated to support the new dynamic remkarketing events (reference1: https://support.google.com/google-ads/answer/3103357?hl=en, reference2: https://support.google.com/google-ads/answer/7305793), but this implementation has a bug: the "value" event parameter never get sent by the template.

This custom template mimics what the gtag snippet send to the network. We hope Google fix the problem on the official template in the next few months.


